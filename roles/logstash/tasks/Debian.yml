---

#- name: Ensure python-pycurl is installed
#  apt: pkg=python-pycurl state=installed

- name: Ensure elasticsearch apt signing key is installed
  apt_key: url={{url_gpg_key}} state=present

- name: Ensure logstash repository is installed
  apt_repository: repo="deb {{url_logstash_pkg}} stable main" update_cache=yes

- name: Ensure java and logstash are installed
  apt: pkg={{item}} state=installed
  with_items:
    - openjdk-7-jre
    - logstash

- name: Ensure redis is installed
  apt: pkg=redis-server state=installed

- name: Ensure redis service config is in place
  copy: src=redis.conf
        dest=/etc/redis/redis.conf
        owner=root group=root mode=0644
  notify:
    - restart redis

- name: Ensure redis boots on startup
  shell: update-rc.d redis-server defaults
  notify:
    - restart redis

 - name: Ensure logstash service is run as the root user
  copy: src=logstash
        dest=/etc/init.d/logstash
        owner=root group=root mode=0755
  notify:
    - restart logstash

- name: Ensure logstash config is in place
  copy: src=central.conf
        dest=/etc/logstash/conf.d/central.conf
        owner=root group=root mode=0644
  notify:
    - restart logstash

- name: Ensure logstash boots on startup
  shell: update-rc.d logstash defaults
  notify:
    - restart logstash


#- name: Ensure SSL certificates have the correct directories
#  file: path=/etc/pki/tls/{{item}} owner=root group=root mode=0755 state=directory
#  with_items:
#    - certs
#    - private
#  notify:
#    - restart logstash

#- name: Ensure logstash-forwarder has its SSL certificate
#  copy: src=certs/logstash-forwarder.crt dest=/etc/pki/tls/certs/logstash-forwarder.crt owner=root group=root mode=0755
#  notify:
#   - restart logstash

#- name: Ensure logstash-forwarder has its SSL private key
#  copy: src=certs/logstash-forwarder.key dest=/etc/pki/tls/private/logstash-forwarder.key owner=root group=root mode=0755
#  notify:
#    - restart logstash